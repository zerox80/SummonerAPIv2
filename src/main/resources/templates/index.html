<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="SummonerAPI - Search League of Legends summoners, view ranks, recent matches and champion stats.">
    <meta name="theme-color" id="themeColor" content="#0b1018">
    <title>SummonerAPI - League Stats</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="shortcut icon" href="/favicon.ico">
    <!-- Preconnects for faster CDN fetches -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <!-- Bootswatch Theme (default to dark; JS may swap href) -->
    <link id="themeStylesheet" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/5.3.7/darkly/bootstrap.min.css" integrity="sha512-p5mHOC7N2BAy1SdoU/f2XD4t7EM05/5b1QowPXdyvqrSFsWQl3HVqY60hvvnOcMVBXBwr3ysopvGgxqbaovv/Q==" crossorigin="anonymous">
    <noscript>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/5.3.7/darkly/bootstrap.min.css" integrity="sha512-p5mHOC7N2BAy1SdoU/f2XD4t7EM05/5b1QowPXdyvqrSFsWQl3HVqY60hvvnOcMVBXBwr3ysopvGgxqbaovv/Q==" crossorigin="anonymous">
    </noscript>
    <!-- Google Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha384-PPIZEGYM1v8zp5Py7UjFb79S58UeqCL9pYVnVPURKEqvioPROaVAJKKLzvH2rDnI" crossorigin="anonymous">
    <!-- App Styles (versioned via ResourceUrlEncodingFilter) -->
    <link rel="stylesheet" th:href="@{/css/app.css}" href="/css/app.css">
</head>
<body class="app-body">
<nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top glass-nav border-bottom border-secondary-subtle">
    <div class="container-fluid">
        <a class="navbar-brand fw-semibold" href="/"><i class="fas fa-chart-line" aria-hidden="true"></i> SummonerAPI</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarDefault" aria-controls="navbarDefault" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarDefault">
            <ul class="navbar-nav me-auto mb-2 mb-md-0">
                <li class="nav-item">
                    <a class="nav-link" th:classappend="${activePage == null || activePage == 'home'} ? 'active' : ''" th:attr="aria-current=${activePage == null || activePage == 'home'} ? 'page' : null" href="/">Home</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" th:classappend="${activePage == 'champions'} ? 'active' : ''" th:attr="aria-current=${activePage == 'champions'} ? 'page' : null" href="/champions">Champions</a>
                </li>
            </ul>
            <span class="navbar-text me-3">
                Currently only <span th:text="${platformRegion != null ? #strings.toUpperCase(platformRegion) : 'EUW1'}">EUW1</span> is supported.
            </span>
            <button id="themeToggle" class="btn btn-sm btn-outline-secondary" type="button" title="Toggle theme" aria-label="Switch to light mode" aria-pressed="false">
                <i class="fa-regular fa-moon" aria-hidden="true"></i>
            </button>
        </div>
    </div>
</nav>

<main class="container mt-5">
    <!-- Hero/Search -->
    <section class="hero glass-card rounded-4 p-4 mb-4 shadow-lg position-relative">
        <div class="position-absolute gradient-orb orb-1"></div>
        <div class="position-absolute gradient-orb orb-2"></div>
        <div class="text-center mb-4">
            <h1 class="display-5 fw-bold mb-2">Summoner Profile Search</h1>
            <p class="text-secondary mb-0">Check ranks, recent matches, and champions at a glance.</p>
        </div>
        <form th:action="@{/search}" method="get" class="position-relative">
            <div class="input-group input-group-sm search-group shadow-sm rounded-3">
                <span class="input-group-text bg-transparent border-0 ps-3"><i class="fas fa-user-tag text-secondary" aria-hidden="true"></i></span>
                <label for="riotId" class="visually-hidden">Riot ID</label>
                <input type="text" id="riotId" name="riotId" class="form-control bg-transparent border-0 text-light" placeholder="Enter Riot ID (e.g., Name#TAG)" required autocomplete="off" spellcheck="false" autocapitalize="off" role="combobox" aria-autocomplete="list" aria-controls="suggestions-container" aria-expanded="false" aria-haspopup="listbox" aria-label="Search for summoner by Riot ID" th:value="${riotId}" />
                <button class="btn btn-primary px-4" type="submit"><i class="fas fa-search me-1" aria-hidden="true"></i> Search</button>
                <div id="suggestions-container" class="list-group suggestions-dropdown w-100" role="listbox" aria-label="Suggestions"></div>
            </div>
            
        </form>
    </section>

    <!-- Two-column layout when a summoner is present -->
    <div th:if="${summoner}" class="row g-4">
        <!-- Left sidebar -->
        <div class="col-12 col-lg-4 sidebar-sticky">
        <div class="card section-card glass-card shadow-sm">
        <div class="card-header section-header d-flex align-items-center gap-2">
            <i class="fa-solid fa-user-astronaut text-primary" aria-hidden="true"></i>
            Summoner Information
        </div>
        <div class="card-body">
            <div class="d-flex align-items-center mb-3">
                <img th:if="${profileIconUrl}" th:src="${profileIconUrl}"
                     alt="Profile Icon" class="rounded-circle me-3 profile-avatar" width="112" height="112" loading="lazy"/>
                <div>
                    <h5 class="mb-0" th:text="${not #strings.isEmpty(summoner.name) ? summoner.name : 'N/A'}">N/A</h5>
                    <small class="text-muted">Level <span th:text="${summoner.summonerLevel}">N/A</span></small>
                </div>
            </div>
            <!-- PUUID Removed as per request -->
            <!-- <p class="mb-0"><strong>PUUID:</strong> <small th:text="${summoner.puuid}" class="text-muted">N/A</small></p> -->
        </div>
        </div>

        <!-- Display League Entries -->
        <div th:if="${leagueEntries != null && !leagueEntries.isEmpty()}" class="card section-card glass-card shadow-sm">
        <div class="card-header section-header d-flex align-items-center gap-2">
            <a data-bs-toggle="collapse" href="#rankedInfoCollapse" role="button" aria-expanded="true" aria-controls="rankedInfoCollapse"
               class="d-flex align-items-center gap-2 text-decoration-none text-reset w-100">
                <i class="fa-solid fa-trophy text-warning" aria-hidden="true"></i>
                <span class="flex-grow-1">Ranked Information</span>
                <i class="fas fa-chevron-down fa-xs chev" aria-hidden="true"></i>
            </a>
        </div>
        <div id="rankedInfoCollapse" class="collapse show">
            <div class="list-group list-group-flush">
                <div th:each="entry : ${leagueEntries}" class="list-group-item league-entry">
                    <div class="d-flex w-100 justify-content-between mb-2">
                        <h4 class="mb-1">
                            <img th:src="${bases.rankedMiniCrest + ((entry.tier != null and #strings.equalsIgnoreCase(entry.tier, 'EMERALD'))
                                  ? 'emerald.svg'
                                  : ((entry.tier != null ? entry.tier.toLowerCase() : 'unranked') + '.png'))}"
                                 th:alt="${(entry.tier != null ? entry.tier.toLowerCase() : 'unranked') + ' Tier'}"
                                 class="tier-icon" loading="lazy"/>
                            <span th:text="${entry.queueType != null ? entry.queueType.replace('_', ' ').toLowerCase() : 'N/A'}" class="text-capitalize">Queue</span>
                        </h4>
                        <small th:text="${(entry.tier != null ? entry.tier.toLowerCase() : 'Unranked') + ' ' + (entry.rank != null ? entry.rank : '-')}" class="text-capitalize">Tier Rank</small>
                    </div>
                    <div class="mb-1 d-flex flex-wrap gap-2">
                        <span class="badge rounded-pill bg-secondary-subtle text-light-emphasis" th:text="${entry.leaguePoints + ' LP'}">0 LP</span>
                        <span class="badge rounded-pill bg-success-subtle text-success-emphasis" th:text="${'W ' + entry.wins}">W 0</span>
                        <span class="badge rounded-pill bg-danger-subtle text-danger-emphasis" th:text="${'L ' + entry.losses}">L 0</span>
                        <span class="badge rounded-pill bg-info-subtle text-info-emphasis" th:if="${entry.wins + entry.losses > 0}" th:text="${'WR ' + T(java.lang.Math).round((entry.wins * 1.0 / (entry.wins + entry.losses)) * 100.0) + '%'}">WR 0%</span>
                    </div>
                    <small th:if="${entry.wins + entry.losses > 0}">
                        Winrate: <span th:text="${T(java.lang.Math).round( (entry.wins * 1.0 / (entry.wins + entry.losses)) * 100.0 )}">0</span>%
                    </small>
                </div>
            </div>
        </div>
        </div>

    <!-- Recently Played (own collapsible card) -->
    <div th:if="${summoner != null}" class="card section-card glass-card shadow-sm">
        <div class="card-header section-header d-flex align-items-center gap-2">
            <a data-bs-toggle="collapse" href="#recentlyCollapse" role="button" aria-expanded="true" aria-controls="recentlyCollapse"
               class="d-flex align-items-center gap-2 text-decoration-none text-reset w-100">
                <i class="fa-solid fa-clock-rotate-left text-info" aria-hidden="true"></i>
                <span class="flex-grow-1">Recently Played Champions (Last <span id="recentCount" th:text="${matchHistory != null ? matchHistory.size() : 0}">0</span> Games)</span>
                <i class="fas fa-chevron-down fa-xs chev" aria-hidden="true"></i>
            </a>
        </div>
        <div id="recentlyCollapse" class="collapse show">
            <div id="recentChampsBody" class="card-body py-3">
                <div th:if="${championPlayCounts != null && !championPlayCounts.isEmpty()}">
                    <ul class="list-unstyled mb-0">
                        <li th:each="champEntry, iterStat : ${championPlayCounts.entrySet()}" th:if="${iterStat.count <= 5}" class="d-flex align-items-center mb-2">
                            <img th:src="${bases.champSquare + champEntry.key + '.png'}"
                                 th:alt="${champEntry.key}"
                                 class="me-2 rounded recent-champ-icon"
                                  loading="lazy"/>
                            <span th:text="${champEntry.key}" class="fw-medium">ChampionName</span>
                            <span class="text-muted mx-2">&bull;</span>
                            <span th:text="${champEntry.value}">0</span>
                            <span class="ms-1 text-muted">games</span>
                        </li>
                    </ul>
                </div>
                <div th:if="${championPlayCounts != null && championPlayCounts.isEmpty() && matchHistory != null && !matchHistory.isEmpty()}" class="mt-1">
                    <p class="text-muted mb-0">No champion data from recent matches to display.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- LP Progression Chart (collapsible) -->
    <div th:if="${
            summoner != null && (
                (leagueEntries != null && !leagueEntries.isEmpty())
                || (matchHistory != null && !#lists.isEmpty(matchHistory.?[info.queueId == 420 || info.queueId == 440]))
            )
        }" class="card section-card glass-card shadow-sm">
        <div class="card-header section-header d-flex align-items-center gap-2">
            <a data-bs-toggle="collapse" href="#lpCollapse" role="button" aria-expanded="true" aria-controls="lpCollapse"
               class="d-flex align-items-center gap-2 text-decoration-none text-reset w-100">
                <i class="fa-solid fa-chart-line text-primary" aria-hidden="true"></i>
                <span class="flex-grow-1">LP Progression (last matches)</span>
                <i class="fas fa-chevron-down fa-xs chev" aria-hidden="true"></i>
            </a>
        </div>
        <div id="lpCollapse" class="collapse show">
            <div class="card-body">
                <canvas id="lpChart" class="chart-canvas" height="120"></canvas>
                <small class="text-muted d-block mt-2">If absolute LP is unavailable, the chart shows relative LP change.</small>
            </div>
        </div>
    </div>

    <!-- LP Progression: No data message -->
    <div th:if="${
            summoner != null && (
                (leagueEntries == null || leagueEntries.isEmpty())
                and (matchHistory == null || #lists.isEmpty(matchHistory.?[info.queueId == 420 || info.queueId == 440]))
            )
        }" class="card section-card glass-card shadow-sm">
        <div class="card-header section-header d-flex align-items-center gap-2">
            <i class="fa-solid fa-chart-line text-secondary" aria-hidden="true"></i>
            LP Progression (last matches)
        </div>
        <div class="card-body">
            <p class="mb-0 text-muted">No ranked LP data to display yet. Play some ranked Solo/Duo or Flex matches to fill this chart.</p>
        </div>
    </div>

    <!-- Champion Distribution Chart (collapsible) -->
    <div th:if="${championPlayCounts != null && !championPlayCounts.isEmpty()}" class="card section-card glass-card shadow-sm">
        <div class="card-header section-header d-flex align-items-center gap-2">
            <a data-bs-toggle="collapse" href="#championCollapse" role="button" aria-expanded="true" aria-controls="championCollapse"
               class="d-flex align-items-center gap-2 text-decoration-none text-reset w-100">
            <i class="fa-solid fa-chart-pie text-warning" aria-hidden="true"></i>
                <span class="flex-grow-1">Champion Distribution (recent matches)</span>
                <i class="fas fa-chevron-down fa-xs chev" aria-hidden="true"></i>
            </a>
        </div>
        <div id="championCollapse" class="collapse show">
            <div class="card-body">
                <canvas id="championChart" class="chart-canvas chart-doughnut" height="120"></canvas>
            </div>
        </div>
    </div>
    
    <div th:if="${leagueEntries != null && leagueEntries.isEmpty() && summoner != null && leagueError == null}" class="alert alert-info info-message glass-card" role="alert">
        No ranked data found for this summoner (possibly unranked in all queues).
    </div>
    <div th:if="${leagueError}" class="alert alert-danger error-message glass-card" role="alert">
        <strong th:text="${leagueError}">Error loading league data.</strong>
    </div>

        </div> <!-- /col (left) -->

        <!-- Center content: Match History -->
        <div class="col-12 col-lg-8">
    <!-- Match History Section -->
    <div th:if="${summoner != null && matchHistory != null}" class="card section-card glass-card shadow-sm">
        <div class="card-header section-header compact d-flex align-items-center">
            <a data-bs-toggle="collapse" href="#matchHistoryCollapse" role="button" aria-expanded="true" aria-controls="matchHistoryCollapse"
               class="d-flex align-items-center gap-2 text-decoration-none text-reset w-100">
                <i class="fa-solid fa-scroll text-info" aria-hidden="true"></i>
                <span class="flex-grow-1">Match History <small class="text-muted" th:text="${matchHistory != null && matchHistory.size() > 0 ? '(' + matchHistory.size() + ')' : ''}"></small></span>
                <i class="fas fa-chevron-down fa-xs chev" aria-hidden="true"></i>
            </a>
        </div>
        <div class="px-3 py-2 d-flex align-items-center gap-2 flex-wrap history-controls">
            <ul class="nav nav-pills" id="historyFilters" role="tablist">
                <li class="nav-item" role="presentation"><button id="filterAll" class="nav-link active" data-filter="all" type="button" aria-label="Show all matches">All</button></li>
                <li class="nav-item" role="presentation"><button id="filterRanked" class="nav-link" data-filter="ranked" type="button" aria-label="Show ranked matches only">Ranked</button></li>
                
            </ul>
            <div class='dropdown ms-1'>
                <button class='btn btn-sm btn-secondary dropdown-toggle shadow-sm' type='button' data-bs-toggle='dropdown' data-bs-display='static' aria-expanded='false' id='queueToggle'>All queues</button>
                <ul class='dropdown-menu dropdown-menu-dark' id='queueDropdown' aria-labelledby='queueToggle'></ul>
            </div>

            <div class="ms-auto">
                <div class="input-group input-group-sm match-search-group">
                    <span class="input-group-text bg-transparent border-0"><i class="fas fa-search"></i></span>
                    <input type="search" id="matchSearch" class="form-control" placeholder="Search champion or player" aria-label="Search matches">
                </div>
            </div>
        </div>
        <div class="px-3 py-2 history-summary text-secondary small">
            <span id="summaryWR">WR: -</span>
            <span class="mx-2">&bull;</span>
            <span id="summaryKDA">KDA: -</span>
            <span class="mx-2">&bull;</span>
            <span id="summaryCount">Last 20 games</span>
        </div>
        <div class="collapse show" id="matchHistoryCollapse">
            <div th:if="${matchHistory.isEmpty()}" class="card-body">
                <p th:if="${matchHistoryInfo}" th:text="${matchHistoryInfo}">No recent matches found.</p>
                <p th:unless="${matchHistoryInfo}">No recent matches found or an error occurred.</p>
            </div>
            <div th:if="${matchHistoryError}" class="alert alert-warning m-3" role="alert" th:text="${matchHistoryError}">
                Error loading match history.
            </div>

            <!-- Empty-state message for when filters/search hide all rows -->
            <div id="noMatchesMsg" class="text-muted small px-3 py-2">
                No matches found for your current filters or search.
            </div>

            <div id="matchList" class="list-group list-group-flush" th:unless="${matchHistory.isEmpty()}"
                 th:attr="data-puuid=${summoner != null ? summoner.puuid : ''}, data-riotid=${riotId != null ? riotId : ''}, data-champsquare=${bases.champSquare}">
                <th:block th:each="match, iterStat : ${matchHistory}">
                    <!-- Render only if we have basic match info -->
                    <th:block th:if="${match != null and match.info != null}">
                    <div th:with="gd=${match.info.gameDuration != null ? match.info.gameDuration : 0}, isRemake=${gd > 0 && gd <= 300}, meList=${match.info.participants != null ? match.info.participants.?[puuid==#vars.summoner.puuid] : null}, me=${meList != null && !#lists.isEmpty(meList) ? meList[0] : null}"
                         class="list-group-item match-row"
                         th:classappend="${isRemake ? ' remake' : (me != null && me.win ? ' win' : ' loss')}"
                         th:attr="data-q=${match.info.queueId}, data-k=${me != null ? me.kills : 0}, data-d=${me != null ? me.deaths : 0}, data-a=${me != null ? me.assists : 0}, data-win=${me != null ? me.win : false}, data-remake=${isRemake}">
                        <span class="d-none search-index">
                            <th:block th:with="meList=${match.info.participants != null ? match.info.participants.?[puuid==#vars.summoner.puuid] : null}, me=${meList != null && !#lists.isEmpty(meList) ? meList[0] : null}">
                                <span th:text="${me != null ? me.championName : ''}"></span>
                            </th:block>
                            <th:block th:if="${match.info.participants != null}" th:each="p : ${match.info.participants}">
                                <span th:text="${(p.riotIdGameName != null && p.riotIdTagline != null) ? p.riotIdGameName + '#' + p.riotIdTagline : ''}"></span>
                            </th:block>
                        </span>
                        <div class="d-flex w-100 justify-content-between">
                            <h5 class="mb-1" th:with="q=${match.info.queueId}, gd=${match.info.gameDuration != null ? match.info.gameDuration : 0}, min=${gd / 60}, sec=${gd % 60}">
                                <span th:switch="${q}">
                                    <span th:case="'420'">Ranked Solo/Duo</span>
                                    <span th:case="'440'">Ranked Flex</span>
                                    <span th:case="'400'">Normal Draft</span>
                                    <span th:case="'430'">Normal Blind</span>
                                    <span th:case="'450'">ARAM</span>
                                    <span th:case="'700'">Clash</span>
                                    <span th:case="'1700'">Arena</span>
                                    <span th:case="*" th:text="${match.info.gameMode != null ? #strings.replace(match.info.gameMode,'_',' ') : ('Queue ' + q)}">Match</span>
                                </span>
                                <span th:text="${' (' + min + 'm ' + sec + 's)'}">(0m 0s)</span>
                            </h5>
                            <div class="d-flex align-items-center">
                                <th:block th:with="gd=${match.info.gameDuration != null ? match.info.gameDuration : 0}, isRemake=${gd > 0 && gd <= 300}, meList=${match.info.participants != null ? match.info.participants.?[puuid==#vars.summoner.puuid] : null}, me=${meList != null && !#lists.isEmpty(meList) ? meList[0] : null}">
                                    <span class="badge rounded-pill px-3 py-2 fw-semibold"
                                          th:text="${isRemake ? 'Remake' : (me != null && me.win ? 'Victory' : 'Defeat')}"
                                          th:classappend="${isRemake ? 'bg-secondary-subtle text-secondary-emphasis' : (me != null && me.win ? 'bg-success-subtle text-success-emphasis' : 'bg-danger-subtle text-danger-emphasis')}"></span>
                                    <span th:if="${match.info.lpChange != null && !isRemake}"
                                          th:text="${(match.info.lpChange > 0 ? '+' : '') + match.info.lpChange + ' LP'}"
                                          th:classappend="${match.info.lpChange > 0 ? 'lp-badge gain ms-2' : (match.info.lpChange < 0 ? 'lp-badge loss ms-2' : 'lp-badge neutral ms-2')}">
                                    </span>
                                </th:block>
                            </div>
                        </div>
                        <p class="mb-2 match-details-summary">
                            <small th:text="${'Match ID: ' + (match != null && match.metadata != null ? match.metadata.matchId : 'N/A')}">Match ID: N/A</small> &bull;
                            <small th:text="${match.info.gameEndTimestamp > 0 ? #dates.format(new java.util.Date(match.info.gameEndTimestamp), 'dd MMM yyyy HH:mm') : '--'}"></small>
                        </p>

                        <!-- Searched Summoner's Performance -->
                        <th:block th:if="${match.info.participants != null}">
                            <div th:each="p : ${match.info.participants}" th:if="${p.puuid == #vars.summoner.puuid}" class="mb-3 p-2 player-performance">
                                <strong>Your Performance:</strong>
                                <img th:src="${(champImgByKey != null and champImgByKey.containsKey(p.championId)) ? champImgByKey[p.championId] : (bases.champSquare + p.championName + '.png')}" th:alt="${p.championName}" width="32" height="32" class="me-1 align-middle rounded" loading="lazy" />
                                <span th:text="${p.championName}" class="fw-medium">Champ</span> -
                                KDA: <span th:text="${p.kda}" class="fw-bold">K/D/A</span>
                            </div>
                        </th:block>

                        <!-- Participants Table -->
                        <details class="mt-2 w-100" th:if="${match.info.participants != null}">
                            <summary class="btn btn-sm btn-participants">Show All Participants <i class="fas fa-users fa-xs" aria-hidden="true"></i></summary>

                        <!-- Blue Team Table -->
                        <h6 class="mt-3 text-primary">Blue Team</h6>
                        <div class="table-responsive">
                        <table class="table table-sm table-hover mt-2 match-table team-blue-table table-borderless align-middle">
                            <thead>
                            <tr>
                                <th scope="col">Champion</th>
                                <th scope="col">Player</th>
                                <th scope="col">KDA</th>
                            </tr>
                            </thead>
                            <tbody th:with="searchedPuuid=${#vars.summoner.puuid}">
                            <tr th:each="p : ${match.info.participants}" th:if="${p.teamId == 100}"
                                th:classappend="${p.puuid == searchedPuuid ? 'table-info self-row' : ''}">
                                <td>
                                    <img th:src="${(champImgByKey != null and champImgByKey.containsKey(p.championId)) ? champImgByKey[p.championId] : (bases.champSquare + p.championName + '.png')}" th:alt="${p.championName}" width="24" height="24" class="me-1 align-middle rounded" loading="lazy" />
                                    <span th:text="${p.championName}">Champion</span>
                                </td>
                                <td>
                                    <a class="text-break" th:if="${p.riotIdGameName != null && p.riotIdTagline != null && !(p.riotIdGameName.isBlank() && p.riotIdTagline.isBlank())}"
                                       th:href="@{/search(riotId=${p.riotIdGameName + '#' + p.riotIdTagline})}"
                                       th:text="${p.riotIdGameName + '#' + p.riotIdTagline}"
                                       title="Search this player">Player Name</a>
                                    <span class="text-break" th:unless="${p.riotIdGameName != null && p.riotIdTagline != null && !(p.riotIdGameName.isBlank() && p.riotIdTagline.isBlank())}"
                                          th:text="${p.summonerName} ?: 'Unknown Player'">Player Name</span>
                                </td>
                                <td th:text="${p.kda}" class="fw-medium">K/D/A</td>
                            </tr>
                            </tbody>
                        </table>
                        </div>

                        <!-- Red Team Table -->
                        <h6 class="mt-3 text-danger">Red Team</h6>
                        <div class="table-responsive">
                        <table class="table table-sm table-hover mt-2 match-table team-red-table table-borderless align-middle">
                            <thead>
                            <tr>
                                <th scope="col">Champion</th>
                                <th scope="col">Player</th>
                                <th scope="col">KDA</th>
                            </tr>
                            </thead>
                            <tbody th:with="searchedPuuid=${#vars.summoner.puuid}">
                            <tr th:each="p : ${match.info.participants}" th:if="${p.teamId == 200}"
                                th:classappend="${p.puuid == searchedPuuid ? 'table-info self-row' : ''}">
                                <td>
                                    <img th:src="${(champImgByKey != null and champImgByKey.containsKey(p.championId)) ? champImgByKey[p.championId] : (bases.champSquare + p.championName + '.png')}" th:alt="${p.championName}" width="24" height="24" class="me-1 align-middle rounded" loading="lazy" />
                                    <span th:text="${p.championName}">Champion</span>
                                </td>
                                <td>
                                    <a th:if="${p.riotIdGameName != null && p.riotIdTagline != null && !(p.riotIdGameName.isBlank() && p.riotIdTagline.isBlank())}"
                                       th:href="@{/search(riotId=${p.riotIdGameName + '#' + p.riotIdTagline})}"
                                       th:text="${p.riotIdGameName + '#' + p.riotIdTagline}"
                                       title="Search this player">Player Name</a>
                                    <span class="text-break" th:unless="${p.riotIdGameName != null && p.riotIdTagline != null && !(p.riotIdGameName.isBlank() && p.riotIdTagline.isBlank())}"
                                          th:text="${p.summonerName} ?: 'Unknown Player'">Player Name</span>
                                </td>
                                <td th:text="${p.kda}" class="fw-medium">K/D/A</td>
                            </tr>
                            </tbody>
                        </table>
                        </div>
                    </details>
                    </div>
                    </div>
                    </th:block>
                    <!-- Fallback row if match.info is missing (won't break page) -->
                    <th:block th:if="${match == null or match.info == null}">
                    <div class="list-group-item match-row" th:attr="data-q=0, data-k=0, data-d=0, data-a=0, data-win=false, data-remake=false">
                        <div class="small">
                            <strong th:text="${'Match ID: ' + (match != null && match.metadata != null ? match.metadata.matchId : 'N/A')}">Match ID: N/A</strong>
                            <span class="text-muted ms-2">Unsupported match data</span>
                        </div>
                    </div>
                    </th:block>
                </th:block>
            </div>
            <!-- Load More: placed below the match list for better UX -->
            <div class="p-3 text-center" th:if="${summoner != null}">
                <button id="loadMoreBtn" class="btn btn-outline-secondary btn-sm">
                    <span class="label">Load more</span>
                    <span class="spinner-border spinner-border-sm align-text-top d-none" role="status" aria-hidden="true"></span>
                </button>
            </div>
        </div>
    </div>
    <!-- End Match History Section -->

    <!-- Debug: Show match IDs and info presence when debug=1 is set in URL -->
    <div th:if="${param.debug != null and param.debug[0] == '1'}" class="text-muted small px-3 py-2">
        <div>Debug: matches = <span th:text="${matchHistory != null ? matchHistory.size() : 0}">0</span></div>
        <ul class="mb-0">
            <li th:each="mm : ${matchHistory}"
                th:text="${(mm != null && mm.metadata != null ? mm.metadata.matchId : 'N/A') + ' | info=' + (mm != null && mm.info != null)}">-</li>
        </ul>
    </div>

        </div> <!-- /col (right) -->
    </div> <!-- /row -->

    <div th:if="${error}" class="alert alert-danger error-message mt-4" role="alert">
        <strong th:text="${error}">An error occurred.</strong>
    </div>
</main>

<footer class="footer mt-auto py-3 bg-dark">
    <div class="container text-center">
        <span class="text-muted">SummonerAPI by <a href="/mavi.html" class="link-light text-decoration-underline">Mavi</a>. This project is not affiliated with or endorsed by Riot Games.</span>
    </div>
</footer>

<!-- Bootstrap JS Bundle (Popper.js included) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<!-- Chart.js for charts (with SRI) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.5.0/chart.umd.min.js" integrity="sha512-Y51n9mtKTVBh3Jbx5pZSJNDDMyY+yGe77DGtBPzRlgsf/YLCh13kSZ3JmfHGzYFCmOndraf0sQgfM654b7dJ3w==" crossorigin="anonymous"></script>
<script th:src="@{/js/main.js}"></script>
<!-- Export data to window for use in modules -->
<script th:inline="javascript" th:attr="nonce=${cspNonce}">
    // Chart data
    /*<![CDATA[*/
    window.leagueEntriesData = [
    /*[# th:each="e, iterStat : ${leagueEntries}"]*/
    /*[# th:if="${e != null}"]*/
        { queueType: /*[[${e?.queueType}]]*/'', lp: /*[[${e?.leaguePoints}]]*/0 }/*[[${iterStat.last ? '' : ','}]]*/
    /*[/]*/
    /*[/]*/
    ];

    window.matchesData = [
    /*[# th:each="m, iterStat : ${matchHistory}"]*/
    /*[# th:if="${m != null}"]*/
        { t: /*[[${m?.info?.gameEndTimestamp}]]*/0, q: /*[[${m?.info?.queueId}]]*/0, d: /*[[${m?.info?.lpChange}]]*/null }/*[[${iterStat.last ? '' : ','}]]*/
    /*[/]*/
    /*[/]*/
    ];

    window.champLabelsData = [
    /*[# th:each="e, iterStat : ${championPlayCounts.entrySet()} "]*/
    /*[# th:if="${e != null}"]*/
        /*[[${e?.key}]]*/''/*[[${iterStat.last ? '' : ','}]]*/
    /*[/]*/
    /*[/]*/
    ];
    window.champValuesData = [
    /*[# th:each="e, iterStat : ${championPlayCounts.entrySet()} "]*/
    /*[# th:if="${e != null}"]*/
        /*[[${e?.value}]]*/0/*[[${iterStat.last ? '' : ','}]]*/
    /*[/]*/
    /*[/]*/
    ];

    window.matchesPageSizeData = /*[[${matchesPageSize}]]*/ 10;
    /*]]>*/
</script>
<!-- Main app module -->
<script type="module" th:src="@{/js/app.js}"></script>
</body>
</html>
